# 进度记录与恢复参考

## 进度记录与恢复

### 1. 进度记录文件

每个关键操作都会更新 `.claude-progress.json`：

```json
{
  "version": "1.0",
  "task": "实现用户登录功能",
  "workflow": "autonomous-dev",
  "started_at": "2024-01-01T10:00:00Z",
  "updated_at": "2024-01-01T10:15:23Z",

  "current_stage": {
    "id": 3,
    "name": "测试验证",
    "status": "in_progress",
    "started_at": "2024-01-01T10:10:00Z",
    "progress": "运行测试中，已完成 5/8 个测试文件"
  },

  "stages": [
    {
      "id": 1,
      "name": "需求分析",
      "status": "completed",
      "started_at": "2024-01-01T10:00:00Z",
      "completed_at": "2024-01-01T10:02:00Z",
      "duration_seconds": 120,
      "notes": "分析完成，识别3个核心模块"
    },
    {
      "id": 2,
      "name": "代码实现",
      "status": "completed",
      "started_at": "2024-01-01T10:02:00Z",
      "completed_at": "2024-01-01T10:10:00Z",
      "duration_seconds": 480,
      "tasks_completed": 8,
      "notes": "实现登录组件、API和数据库模型"
    },
    {
      "id": 3,
      "name": "测试验证",
      "status": "in_progress",
      "started_at": "2024-01-01T10:10:00Z",
      "current_task": "运行集成测试",
      "tests_passed": 12,
      "tests_failed": 2,
      "retry_count": 1
    }
  ],

  "files_modified": [
    {
      "path": "src/components/Login.tsx",
      "action": "created",
      "timestamp": "2024-01-01T10:05:00Z"
    },
    {
      "path": "src/api/auth.ts",
      "action": "created",
      "timestamp": "2024-01-01T10:06:00Z"
    },
    {
      "path": "src/App.tsx",
      "action": "modified",
      "timestamp": "2024-01-01T10:07:00Z"
    }
  ],

  "errors": [
    {
      "stage": 3,
      "timestamp": "2024-01-01T10:12:00Z",
      "error": "测试失败：login.test.ts",
      "details": "TypeError: Cannot read property 'email' of undefined",
      "fix_attempted": "添加了 null 检查",
      "resolved": true
    }
  ],

  "metrics": {
    "total_files_created": 5,
    "total_files_modified": 3,
    "total_tests_written": 15,
    "total_tests_passed": 12,
    "total_errors_fixed": 3,
    "total_retries": 1
  },

  "checkpoints": [
    {
      "id": "checkpoint_stage_2",
      "timestamp": "2024-01-01T10:10:00Z",
      "description": "代码实现完成，准备测试",
      "can_resume_from": true
    }
  ],

  "next_action": "修复失败的测试用例，然后重新运行测试"
}
```

### 2. 执行日志文件

创建 `.claude-dev.log` 记录详细执行过程：

```
[2024-01-01 10:00:00] [INFO] 开始自主开发任务: 实现用户登录功能
[2024-01-01 10:00:01] [STAGE] 阶段 1/5: 需求分析
[2024-01-01 10:00:05] [ACTION] 分析需求: 识别核心功能点
[2024-01-01 10:00:10] [ACTION] 检测技术栈: React + Node.js
[2024-01-01 10:01:00] [ACTION] 确定模块: 登录组件、认证API、用户模型
[2024-01-01 10:02:00] [SUCCESS] 阶段 1 完成 (耗时: 2m)
[2024-01-01 10:02:00] [CHECKPOINT] 保存检查点: checkpoint_stage_1

[2024-01-01 10:02:01] [STAGE] 阶段 2/5: 代码实现
[2024-01-01 10:02:05] [ACTION] 创建文件: src/components/Login.tsx
[2024-01-01 10:03:00] [SUCCESS] 文件创建完成: src/components/Login.tsx (45 lines)
[2024-01-01 10:03:01] [ACTION] 创建文件: src/api/auth.ts
[2024-01-01 10:04:30] [SUCCESS] 文件创建完成: src/api/auth.ts (120 lines)
[2024-01-01 10:05:00] [ACTION] 修改文件: src/App.tsx
[2024-01-01 10:05:15] [SUCCESS] 文件修改完成: src/App.tsx (+15 lines)
[2024-01-01 10:10:00] [SUCCESS] 阶段 2 完成 (耗时: 8m, 文件: 5 created, 3 modified)
[2024-01-01 10:10:00] [CHECKPOINT] 保存检查点: checkpoint_stage_2

[2024-01-01 10:10:01] [STAGE] 阶段 3/5: 测试验证
[2024-01-01 10:10:05] [ACTION] 运行测试命令: npm test
[2024-01-01 10:11:00] [WARN] 测试失败: 2/14 失败
[2024-01-01 10:11:01] [ERROR] login.test.ts:25 - TypeError: Cannot read property 'email' of undefined
[2024-01-01 10:11:02] [ACTION] 分析错误: 缺少 null 检查
[2024-01-01 10:11:30] [ACTION] 修复: 在 Login.tsx 添加 null 检查
[2024-01-01 10:12:00] [ACTION] 重新运行测试 (重试 1/3)
[2024-01-01 10:12:45] [SUCCESS] 测试通过: 14/14
[2024-01-01 10:12:45] [SUCCESS] 阶段 3 完成 (耗时: 2m44s, 重试: 1)
[2024-01-01 10:12:45] [CHECKPOINT] 保存检查点: checkpoint_stage_3

[2024-01-01 10:12:46] [STAGE] 阶段 4/5: 代码审查
[2024-01-01 10:13:00] [ACTION] 检查代码质量
[2024-01-01 10:13:30] [ACTION] 检查安全问题
[2024-01-01 10:14:00] [SUCCESS] 阶段 4 完成 (无问题发现)
[2024-01-01 10:14:00] [CHECKPOINT] 保存检查点: checkpoint_stage_4

[2024-01-01 10:14:01] [STAGE] 阶段 5/5: 提交代码
[2024-01-01 10:14:05] [ACTION] 生成 commit message
[2024-01-01 10:14:10] [ACTION] 执行: git add .
[2024-01-01 10:14:11] [ACTION] 执行: git commit
[2024-01-01 10:14:12] [SUCCESS] 提交完成: abc1234
[2024-01-01 10:14:12] [SUCCESS] 阶段 5 完成

[2024-01-01 10:14:13] [INFO] ═══════════════════════════════════════
[2024-01-01 10:14:13] [INFO] ✅ 自主开发任务完成
[2024-01-01 10:14:13] [INFO] 总耗时: 14m13s
[2024-01-01 10:14:13] [INFO] 文件: 5 created, 3 modified
[2024-01-01 10:14:13] [INFO] 测试: 14/14 passed
[2024-01-01 10:14:13] [INFO] 错误修复: 3 次
[2024-01-01 10:14:13] [INFO] ═══════════════════════════════════════
```

### 3. 检查点机制

**自动保存检查点时机**：
- ✅ 每个阶段完成后
- ✅ 关键操作前（如运行测试、代码审查）
- ✅ 发生错误后修复成功时
- ✅ 用户手动要求时（说"保存检查点"）

**检查点包含**：
- 当前进度状态
- 已完成的工作
- 已修改的文件列表
- 下一步要执行的操作

### 4. 中断恢复

**场景 1：正常阶段中断**
```
用户重连后输入: "继续" / "resume" / "继续之前的任务"

AI 响应：

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔄 检测到未完成的自主开发任务

任务: 实现用户登录功能
状态: 进行中 (阶段 3/5)

进度摘要:
  ✅ 阶段 1: 需求分析 (完成, 2m)
  ✅ 阶段 2: 代码实现 (完成, 8m, 8个文件)
  🔄 阶段 3: 测试验证 (进行中)
     - 当前: 运行集成测试
     - 进度: 5/8 个测试文件
     - 已通过: 12 个测试
     - 失败: 2 个测试
     - 重试次数: 1/3
  ⬜ 阶段 4: 代码审查 (待开始)
  ⬜ 阶段 5: 提交代码 (待开始)

已修改文件:
  新增: 5 个文件
  修改: 3 个文件

上次操作: 2024-01-01 10:15:23
下一步: 修复失败的测试用例

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

选择操作:
  1️⃣  "继续" - 从中断点继续执行
  2️⃣  "重新开始当前阶段" - 重新执行阶段3
  3️⃣  "查看详细日志" - 查看完整执行日志
  4️⃣  "取消" - 放弃任务
```

**场景 2：错误状态中断**
```
AI 响应：

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️  检测到任务在错误状态中断

任务: 实现用户登录功能
状态: 阶段 3 - 测试失败 (重试 3/3 次用尽)

最后错误:
  时间: 2024-01-01 10:20:00
  阶段: 测试验证
  错误: 集成测试持续失败
  详情: API endpoint /api/login 返回 500

已尝试的修复:
  1. 添加错误处理 ❌
  2. 修复数据库连接 ❌
  3. 更新API路由 ❌

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

建议操作:
  1️⃣  "查看错误详情" - 查看完整错误堆栈
  2️⃣  "查看日志" - 查看 .claude-dev.log
  3️⃣  "手动修复后继续" - 你修复后AI继续
  4️⃣  "跳过测试继续" - 跳过当前阶段
  5️⃣  "从上个检查点重试" - 回到阶段2完成时
  6️⃣  "取消任务" - 放弃任务
```

**场景 3：从检查点恢复**
```
用户: "从检查点2恢复"

AI:
✅ 恢复到检查点: checkpoint_stage_2
   时间: 2024-01-01 10:10:00
   描述: 代码实现完成，准备测试

📋 将要重新执行:
   - 阶段 3: 测试验证
   - 阶段 4: 代码审查
   - 阶段 5: 提交代码

⚠️  注意: 阶段3之后的所有修改将被重置

确认继续? (输入"确认"继续)
```

### 5. 进度查询

**实时查询进度**：
```
用户: "当前进度" / "进度如何" / "status"

AI:
📊 当前执行状态

阶段 3/5: 测试验证 (进行中)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░  50%

当前任务: 运行集成测试 (5/8 文件)
耗时: 2m 30s
测试: 12 通过, 2 失败
重试: 1/3

最近操作:
  10:12:00 ✅ 修复 null 检查错误
  10:12:30 🔄 重新运行测试
  10:12:45 ✅ 单元测试全部通过
  10:13:00 🔄 运行集成测试...

预估剩余: 约 8-10 分钟
```

### 6. 手动介入后继续

**支持手动修复后继续**：
```
场景: 测试失败 3 次，AI 暂停

AI: ⚠️  连续失败 3 次，需要人工介入

    问题: API 测试失败
    建议: 检查数据库连接配置

    修复后输入"已修复，继续"

用户: [手动修复代码]
用户: "已修复，继续"

AI: ✅ 收到，从当前位置继续...

    [阶段 3/5] 继续测试验证...
    🔄 重新运行测试...
    ✅ 测试通过!

    继续下一阶段...
```

### 7. 日志查看命令

```
"查看日志" → 显示最近 50 行日志
"查看完整日志" → 显示全部日志
"查看错误日志" → 只显示错误和警告
"查看阶段2日志" → 显示特定阶段的日志
"导出日志" → 将日志保存到文件
```

### 8. 清理策略

**成功完成时**：
- 保留 `.claude-dev.log` (7天后自动清理)
- 删除 `.claude-progress.json`
- 在日志末尾添加完成总结

**失败或取消时**：
- 保留所有文件供排查
- 在进度文件中标记状态为 "failed" 或 "cancelled"
- 不自动清理

**恢复完成后**：
- 在日志中标注 "[RESUMED]"
- 记录从哪个检查点恢复

