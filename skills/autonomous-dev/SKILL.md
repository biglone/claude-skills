---
name: autonomous-dev
description: 自主开发模式。让 AI 自主完成完整开发任务，无需每步确认。当用户要求"自主开发"、"自动完成"、"全自动"时使用。
allowed-tools: Read, Write, Edit, Bash, Grep, Glob, Task
related-skills: auto-code-pipeline, auto-fix-loop, code-reviewer, test-generator
---

# 自主开发模式

让 AI 自主完成从需求分析到代码提交的完整开发任务。

## 核心原则

```
1. 自主决策 - 无需每步确认，自主判断下一步行动
2. 错误恢复 - 遇到错误自动尝试修复，最多重试 3 次
3. 完整闭环 - 从需求到提交完整执行
4. 进度汇报 - 每个阶段完成后简要汇报
```

## 执行流程

```
需求分析 → 方案设计 → 代码实现 → 测试验证 → 代码审查 → 提交代码
    ↓          ↓          ↓          ↓          ↓
   自动       自动       自动       自动       自动
   推进       推进       推进       推进       推进
```

## 阶段定义

### 阶段 1：需求分析（自动）
```
输入：用户的任务描述
执行：
  - 分析任务目标
  - 识别涉及的文件和模块
  - 确定技术方案
输出：简要方案摘要
下一步：自动进入阶段 2
```

### 阶段 2：代码实现（自动）
```
执行：
  - 创建/修改必要的文件
  - 遵循项目现有代码风格
  - 添加必要的注释
输出：修改的文件列表
下一步：自动进入阶段 3
```

### 阶段 3：测试验证（自动）
```
执行：
  - 生成或更新测试用例
  - 运行测试命令
  - 如果失败，自动修复后重试（最多 3 次）
输出：测试结果
下一步：测试通过后自动进入阶段 4
```

### 阶段 4：代码审查（自动）
```
执行：
  - 检查代码质量
  - 检查潜在 bug
  - 检查安全问题
  - 如有问题，自动修复
输出：审查结果
下一步：自动进入阶段 5
```

### 阶段 5：提交代码（自动）
```
执行：
  - 生成规范的 commit message
  - 执行 git add 和 commit
  - 不自动 push（需用户确认）
输出：提交信息
完成：汇报整体结果
```

## 自动继续规则

```
✅ 每个阶段完成后，立即执行下一阶段
✅ 遇到可自动修复的问题，修复后继续
✅ 测试/lint 失败，自动修复后重试
❌ 遇到以下情况暂停并询问用户：
   - 需求不明确
   - 多种方案需要选择
   - 连续 3 次修复失败
   - 涉及删除大量代码
   - 涉及敏感操作（如数据库迁移）
```

## 进度汇报格式

```
[阶段 X/5] ✅ {阶段名称}完成
  - {关键信息 1}
  - {关键信息 2}
→ 自动进入下一阶段...
```

## 最终汇报格式

```
═══════════════════════════════════════
✅ 自主开发任务完成

📋 任务摘要：{一句话描述}

📁 修改文件：
  - {文件 1}：{修改说明}
  - {文件 2}：{修改说明}

🧪 测试结果：{X} 个测试通过

📝 提交信息：
  {commit message}

⚠️  注意事项：
  - {如有需要用户注意的事项}
═══════════════════════════════════════
```

## 触发方式

- "自主开发 {任务描述}"
- "自动完成 {任务描述}"
- "全自动模式 {任务描述}"
- "autonomous mode: {任务描述}"

## 进度记录与恢复

### 1. 进度记录文件

每个关键操作都会更新 `.claude-progress.json`：

```json
{
  "version": "1.0",
  "task": "实现用户登录功能",
  "workflow": "autonomous-dev",
  "started_at": "2024-01-01T10:00:00Z",
  "updated_at": "2024-01-01T10:15:23Z",

  "current_stage": {
    "id": 3,
    "name": "测试验证",
    "status": "in_progress",
    "started_at": "2024-01-01T10:10:00Z",
    "progress": "运行测试中，已完成 5/8 个测试文件"
  },

  "stages": [
    {
      "id": 1,
      "name": "需求分析",
      "status": "completed",
      "started_at": "2024-01-01T10:00:00Z",
      "completed_at": "2024-01-01T10:02:00Z",
      "duration_seconds": 120,
      "notes": "分析完成，识别3个核心模块"
    },
    {
      "id": 2,
      "name": "代码实现",
      "status": "completed",
      "started_at": "2024-01-01T10:02:00Z",
      "completed_at": "2024-01-01T10:10:00Z",
      "duration_seconds": 480,
      "tasks_completed": 8,
      "notes": "实现登录组件、API和数据库模型"
    },
    {
      "id": 3,
      "name": "测试验证",
      "status": "in_progress",
      "started_at": "2024-01-01T10:10:00Z",
      "current_task": "运行集成测试",
      "tests_passed": 12,
      "tests_failed": 2,
      "retry_count": 1
    }
  ],

  "files_modified": [
    {
      "path": "src/components/Login.tsx",
      "action": "created",
      "timestamp": "2024-01-01T10:05:00Z"
    },
    {
      "path": "src/api/auth.ts",
      "action": "created",
      "timestamp": "2024-01-01T10:06:00Z"
    },
    {
      "path": "src/App.tsx",
      "action": "modified",
      "timestamp": "2024-01-01T10:07:00Z"
    }
  ],

  "errors": [
    {
      "stage": 3,
      "timestamp": "2024-01-01T10:12:00Z",
      "error": "测试失败：login.test.ts",
      "details": "TypeError: Cannot read property 'email' of undefined",
      "fix_attempted": "添加了 null 检查",
      "resolved": true
    }
  ],

  "metrics": {
    "total_files_created": 5,
    "total_files_modified": 3,
    "total_tests_written": 15,
    "total_tests_passed": 12,
    "total_errors_fixed": 3,
    "total_retries": 1
  },

  "checkpoints": [
    {
      "id": "checkpoint_stage_2",
      "timestamp": "2024-01-01T10:10:00Z",
      "description": "代码实现完成，准备测试",
      "can_resume_from": true
    }
  ],

  "next_action": "修复失败的测试用例，然后重新运行测试"
}
```

### 2. 执行日志文件

创建 `.claude-dev.log` 记录详细执行过程：

```
[2024-01-01 10:00:00] [INFO] 开始自主开发任务: 实现用户登录功能
[2024-01-01 10:00:01] [STAGE] 阶段 1/5: 需求分析
[2024-01-01 10:00:05] [ACTION] 分析需求: 识别核心功能点
[2024-01-01 10:00:10] [ACTION] 检测技术栈: React + Node.js
[2024-01-01 10:01:00] [ACTION] 确定模块: 登录组件、认证API、用户模型
[2024-01-01 10:02:00] [SUCCESS] 阶段 1 完成 (耗时: 2m)
[2024-01-01 10:02:00] [CHECKPOINT] 保存检查点: checkpoint_stage_1

[2024-01-01 10:02:01] [STAGE] 阶段 2/5: 代码实现
[2024-01-01 10:02:05] [ACTION] 创建文件: src/components/Login.tsx
[2024-01-01 10:03:00] [SUCCESS] 文件创建完成: src/components/Login.tsx (45 lines)
[2024-01-01 10:03:01] [ACTION] 创建文件: src/api/auth.ts
[2024-01-01 10:04:30] [SUCCESS] 文件创建完成: src/api/auth.ts (120 lines)
[2024-01-01 10:05:00] [ACTION] 修改文件: src/App.tsx
[2024-01-01 10:05:15] [SUCCESS] 文件修改完成: src/App.tsx (+15 lines)
[2024-01-01 10:10:00] [SUCCESS] 阶段 2 完成 (耗时: 8m, 文件: 5 created, 3 modified)
[2024-01-01 10:10:00] [CHECKPOINT] 保存检查点: checkpoint_stage_2

[2024-01-01 10:10:01] [STAGE] 阶段 3/5: 测试验证
[2024-01-01 10:10:05] [ACTION] 运行测试命令: npm test
[2024-01-01 10:11:00] [WARN] 测试失败: 2/14 失败
[2024-01-01 10:11:01] [ERROR] login.test.ts:25 - TypeError: Cannot read property 'email' of undefined
[2024-01-01 10:11:02] [ACTION] 分析错误: 缺少 null 检查
[2024-01-01 10:11:30] [ACTION] 修复: 在 Login.tsx 添加 null 检查
[2024-01-01 10:12:00] [ACTION] 重新运行测试 (重试 1/3)
[2024-01-01 10:12:45] [SUCCESS] 测试通过: 14/14
[2024-01-01 10:12:45] [SUCCESS] 阶段 3 完成 (耗时: 2m44s, 重试: 1)
[2024-01-01 10:12:45] [CHECKPOINT] 保存检查点: checkpoint_stage_3

[2024-01-01 10:12:46] [STAGE] 阶段 4/5: 代码审查
[2024-01-01 10:13:00] [ACTION] 检查代码质量
[2024-01-01 10:13:30] [ACTION] 检查安全问题
[2024-01-01 10:14:00] [SUCCESS] 阶段 4 完成 (无问题发现)
[2024-01-01 10:14:00] [CHECKPOINT] 保存检查点: checkpoint_stage_4

[2024-01-01 10:14:01] [STAGE] 阶段 5/5: 提交代码
[2024-01-01 10:14:05] [ACTION] 生成 commit message
[2024-01-01 10:14:10] [ACTION] 执行: git add .
[2024-01-01 10:14:11] [ACTION] 执行: git commit
[2024-01-01 10:14:12] [SUCCESS] 提交完成: abc1234
[2024-01-01 10:14:12] [SUCCESS] 阶段 5 完成

[2024-01-01 10:14:13] [INFO] ═══════════════════════════════════════
[2024-01-01 10:14:13] [INFO] ✅ 自主开发任务完成
[2024-01-01 10:14:13] [INFO] 总耗时: 14m13s
[2024-01-01 10:14:13] [INFO] 文件: 5 created, 3 modified
[2024-01-01 10:14:13] [INFO] 测试: 14/14 passed
[2024-01-01 10:14:13] [INFO] 错误修复: 3 次
[2024-01-01 10:14:13] [INFO] ═══════════════════════════════════════
```

### 3. 检查点机制

**自动保存检查点时机**：
- ✅ 每个阶段完成后
- ✅ 关键操作前（如运行测试、代码审查）
- ✅ 发生错误后修复成功时
- ✅ 用户手动要求时（说"保存检查点"）

**检查点包含**：
- 当前进度状态
- 已完成的工作
- 已修改的文件列表
- 下一步要执行的操作

### 4. 中断恢复

**场景 1：正常阶段中断**
```
用户重连后输入: "继续" / "resume" / "继续之前的任务"

AI 响应：

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔄 检测到未完成的自主开发任务

任务: 实现用户登录功能
状态: 进行中 (阶段 3/5)

进度摘要:
  ✅ 阶段 1: 需求分析 (完成, 2m)
  ✅ 阶段 2: 代码实现 (完成, 8m, 8个文件)
  🔄 阶段 3: 测试验证 (进行中)
     - 当前: 运行集成测试
     - 进度: 5/8 个测试文件
     - 已通过: 12 个测试
     - 失败: 2 个测试
     - 重试次数: 1/3
  ⬜ 阶段 4: 代码审查 (待开始)
  ⬜ 阶段 5: 提交代码 (待开始)

已修改文件:
  新增: 5 个文件
  修改: 3 个文件

上次操作: 2024-01-01 10:15:23
下一步: 修复失败的测试用例

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

选择操作:
  1️⃣  "继续" - 从中断点继续执行
  2️⃣  "重新开始当前阶段" - 重新执行阶段3
  3️⃣  "查看详细日志" - 查看完整执行日志
  4️⃣  "取消" - 放弃任务
```

**场景 2：错误状态中断**
```
AI 响应：

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️  检测到任务在错误状态中断

任务: 实现用户登录功能
状态: 阶段 3 - 测试失败 (重试 3/3 次用尽)

最后错误:
  时间: 2024-01-01 10:20:00
  阶段: 测试验证
  错误: 集成测试持续失败
  详情: API endpoint /api/login 返回 500

已尝试的修复:
  1. 添加错误处理 ❌
  2. 修复数据库连接 ❌
  3. 更新API路由 ❌

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

建议操作:
  1️⃣  "查看错误详情" - 查看完整错误堆栈
  2️⃣  "查看日志" - 查看 .claude-dev.log
  3️⃣  "手动修复后继续" - 你修复后AI继续
  4️⃣  "跳过测试继续" - 跳过当前阶段
  5️⃣  "从上个检查点重试" - 回到阶段2完成时
  6️⃣  "取消任务" - 放弃任务
```

**场景 3：从检查点恢复**
```
用户: "从检查点2恢复"

AI:
✅ 恢复到检查点: checkpoint_stage_2
   时间: 2024-01-01 10:10:00
   描述: 代码实现完成，准备测试

📋 将要重新执行:
   - 阶段 3: 测试验证
   - 阶段 4: 代码审查
   - 阶段 5: 提交代码

⚠️  注意: 阶段3之后的所有修改将被重置

确认继续? (输入"确认"继续)
```

### 5. 进度查询

**实时查询进度**：
```
用户: "当前进度" / "进度如何" / "status"

AI:
📊 当前执行状态

阶段 3/5: 测试验证 (进行中)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░  50%

当前任务: 运行集成测试 (5/8 文件)
耗时: 2m 30s
测试: 12 通过, 2 失败
重试: 1/3

最近操作:
  10:12:00 ✅ 修复 null 检查错误
  10:12:30 🔄 重新运行测试
  10:12:45 ✅ 单元测试全部通过
  10:13:00 🔄 运行集成测试...

预估剩余: 约 8-10 分钟
```

### 6. 手动介入后继续

**支持手动修复后继续**：
```
场景: 测试失败 3 次，AI 暂停

AI: ⚠️  连续失败 3 次，需要人工介入

    问题: API 测试失败
    建议: 检查数据库连接配置

    修复后输入"已修复，继续"

用户: [手动修复代码]
用户: "已修复，继续"

AI: ✅ 收到，从当前位置继续...

    [阶段 3/5] 继续测试验证...
    🔄 重新运行测试...
    ✅ 测试通过!

    继续下一阶段...
```

### 7. 日志查看命令

```
"查看日志" → 显示最近 50 行日志
"查看完整日志" → 显示全部日志
"查看错误日志" → 只显示错误和警告
"查看阶段2日志" → 显示特定阶段的日志
"导出日志" → 将日志保存到文件
```

### 8. 清理策略

**成功完成时**：
- 保留 `.claude-dev.log` (7天后自动清理)
- 删除 `.claude-progress.json`
- 在日志末尾添加完成总结

**失败或取消时**：
- 保留所有文件供排查
- 在进度文件中标记状态为 "failed" 或 "cancelled"
- 不自动清理

**恢复完成后**：
- 在日志中标注 "[RESUMED]"
- 记录从哪个检查点恢复

---

## 安全检查机制

### 1. 文件保护

**自动排除的敏感文件：**
```
.env
.env.*
credentials.json
secrets.*
*.key
*.pem
*.crt
api_keys.json
config/secrets/*
```

**执行前检查：**
```
AI: ⚠️  检测到以下敏感文件

将要修改的文件：
  • .env.local
  • credentials.json

这些文件可能包含敏感信息。

选择操作：
  1️⃣  "跳过这些文件" - 排除敏感文件
  2️⃣  "仅读取不修改" - 只读取参考
  3️⃣  "我确认要修改" - 继续修改（需明确确认）
  4️⃣  "取消" - 终止任务
```

### 2. 危险操作检测

**需要二次确认的操作：**

**大规模删除**
```
AI: ⚠️  危险操作警告

即将删除 15 个文件：
  • src/old/*.js (12 个文件)
  • tests/deprecated/*.test.js (3 个文件)

这是一个大规模删除操作。

确认删除？输入 "确认删除" 继续
```

**数据库相关操作**
```
AI: ⚠️  数据库操作警告

即将执行数据库迁移：
  • 修改 users 表结构
  • 删除 sessions 表的 2 个字段
  • 这个操作不可逆

建议：
  1. 先备份数据库
  2. 在开发环境测试
  3. 确认迁移脚本正确

确认执行？输入 "确认执行数据库迁移"
```

**配置文件修改**
```
AI: ⚠️  配置文件修改警告

即将修改核心配置文件：
  • package.json - 更新依赖版本
  • tsconfig.json - 修改编译选项
  • .env.example - 添加新环境变量

这些修改可能影响项目运行。

查看变更详情？(y/n)
```

### 3. 依赖管理安全

**依赖更新检查：**
```
AI: 📦 依赖更新检查

即将更新以下依赖：
  • react: 17.0.2 → 18.2.0 (主版本升级)
  • axios: 0.27.2 → 1.4.0 (主版本升级)
  • lodash: 4.17.20 → 4.17.21 (补丁版本)

⚠️  主版本升级可能包含破坏性变更

建议：
  1. 查看 CHANGELOG
  2. 检查迁移指南
  3. 在测试环境验证

继续更新？(y/n)
```

**新依赖安装检查：**
```
AI: 📦 新依赖安装

即将安装新依赖：
  • some-unknown-package@1.0.0

安全检查：
  ✅ NPM 官方包
  ✅ 每周下载量: 50,000+
  ✅ 最近更新: 2 个月前
  ⚠️  未知发布者

确认安装？(y/n)
```

### 4. 代码安全扫描

**自动检测的安全问题：**

**SQL 注入**
```javascript
// ❌ 检测到潜在的 SQL 注入
const query = `SELECT * FROM users WHERE id = ${userId}`;

AI: ⚠️  安全问题检测

文件: src/api/users.ts:45
问题: 潜在的 SQL 注入风险
严重程度: 高

建议修复:
  使用参数化查询：
  const query = 'SELECT * FROM users WHERE id = ?';
  db.query(query, [userId]);

自动修复？(y/n)
```

**XSS 风险**
```javascript
// ❌ 检测到潜在的 XSS
element.innerHTML = userInput;

AI: ⚠️  安全问题检测

文件: src/components/Comment.tsx:67
问题: 潜在的 XSS 风险
严重程度: 高

建议修复:
  使用 textContent 或进行转义：
  element.textContent = userInput;
  // 或
  element.innerHTML = escapeHtml(userInput);

自动修复？(y/n)
```

**硬编码凭证**
```javascript
// ❌ 检测到硬编码密钥
const API_KEY = "sk_live_123456789";

AI: ⚠️  安全问题检测

文件: src/config.ts:12
问题: 硬编码的 API 密钥
严重程度: 严重

建议修复:
  使用环境变量：
  const API_KEY = process.env.API_KEY;

  并在 .env 中设置：
  API_KEY=sk_live_123456789

自动修复？(y/n)
```

### 5. 权限检查

**文件权限：**
```
AI: ⚠️  文件权限问题

以下文件权限过于宽松：
  • scripts/deploy.sh (777)
  • config/production.json (666)

建议：
  chmod 755 scripts/deploy.sh
  chmod 644 config/production.json

自动修复权限？(y/n)
```

### 6. 代码规模限制

**单个文件限制：**
```
AI: ⚠️  文件过大警告

文件 src/utils/helpers.ts 包含 850 行代码

建议：
  • 拆分为多个小文件
  • 按功能模块组织
  • 提高代码可维护性

继续？(y/n) 或 "重构这个文件"
```

**单次修改限制：**
```
AI: ⚠️  修改范围过大

本次任务将修改 65 个文件

建议：
  • 拆分为多个小任务
  • 分阶段实施
  • 降低风险

继续？(y/n) 或 "拆分任务"
```

### 7. Git 安全

**防止意外提交：**
```
AI: ⚠️  提交检查

检测到以下文件将被提交：
  ✅ src/api/auth.ts
  ✅ src/components/Login.tsx
  ⚠️  .env.local

.env.local 不应该提交到版本控制

操作：
  • 已自动添加到 .gitignore
  • 已从暂存区移除

继续提交其他文件？(y/n)
```

**分支保护：**
```
AI: ⚠️  分支保护警告

当前在 main 分支，直接提交可能违反团队规范

建议：
  1. 创建功能分支：feature/user-login
  2. 在功能分支开发
  3. 通过 PR 合并到 main

创建新分支？(y/n)
```

### 8. 运行时安全

**资源限制：**
```
AI: ⚠️  资源使用警告

任务运行时间: 45 分钟
CPU 使用率: 85%
内存使用: 2.3 GB

是否继续？(y/n) 或 "优化性能"
```

**网络访问：**
```
AI: ⚠️  网络访问检测

代码尝试访问外部 API：
  • https://api.example.com
  • https://unknown-service.io

建议检查：
  • API 端点是否可信
  • 是否需要添加到白名单

继续？(y/n)
```

### 9. 配置安全检查

**读取安全配置：**
```
AI: 📋 读取安全配置

从 .claude-config.json 加载：
  • 排除文件: 8 个模式
  • 排除目录: 5 个
  • 删除确认阈值: 10 个文件
  • 必须确认操作: 3 类

安全配置已激活 ✅
```

### 10. 审计日志

**记录所有安全相关事件：**
```
[2024-01-01 10:15:00] [SECURITY] 检测到敏感文件: .env
[2024-01-01 10:15:01] [SECURITY] 用户选择: 跳过敏感文件
[2024-01-01 10:20:30] [SECURITY] 危险操作: 删除 15 个文件
[2024-01-01 10:20:45] [SECURITY] 用户确认: 确认删除
[2024-01-01 10:25:00] [SECURITY] 安全扫描: 发现 SQL 注入风险
[2024-01-01 10:25:15] [SECURITY] 自动修复: 使用参数化查询
[2024-01-01 10:30:00] [SECURITY] 提交检查: 排除 .env.local
```

---

## 安全最佳实践

### 1. 定期审查

```bash
# 查看安全日志
"查看安全日志"

# 检查配置
"验证安全配置"

# 审计历史操作
"显示安全审计"
```

### 2. 自定义安全规则

在 `.claude-config.json` 中：
```json
{
  "safety": {
    "excluded_files": [
      ".env*",
      "secrets/*",
      "*.key"
    ],
    "custom_rules": [
      {
        "pattern": "password\\s*=\\s*['\"].*['\"]",
        "message": "硬编码密码",
        "severity": "high",
        "auto_fix": false
      }
    ]
  }
}
```

### 3. 团队安全策略

**共享安全配置：**
```bash
# 团队共享
.claude-config.json  # 提交到仓库

# 个人配置
.claude-config.local.json  # 添加到 .gitignore
```

### 4. CI/CD 集成

```bash
# 在 CI 环境中启用严格模式
export CLAUDE_SAFETY_STRICT=true
export CLAUDE_AUTO_FIX_SECURITY=true
```

---

## 紧急处理

### 如果意外修改了敏感文件

```bash
# 1. 立即停止
"停止"

# 2. 查看修改
git diff

# 3. 撤销修改
git checkout -- .env

# 4. 从检查点恢复
"从上个检查点恢复"
```

### 如果提交了敏感信息

```bash
# 1. 不要 push
# 2. 撤销提交
git reset HEAD~1

# 3. 修改文件
# 4. 重新提交

# 如果已经 push，需要：
# 1. 立即轮换密钥/密码
# 2. 使用 git filter-branch 清理历史（谨慎）
# 3. 通知团队
