---
name: auto-code-pipeline
description: 自动代码流水线。写完代码后自动执行 lint、test、review 流程。当用户要求"自动流水线"、"CI流程"、"自动检查"时使用。
allowed-tools: Read, Write, Edit, Bash, Grep, Glob
related-skills: autonomous-dev, auto-fix-loop, code-reviewer, test-generator, bug-finder
---

# 自动代码流水线

代码修改后自动执行完整的检查和修复流程。

## 流水线流程

```
代码修改
    │
    ▼
┌─────────────┐     失败      ┌─────────────┐
│   Lint      │──────────────▶│  自动修复   │
│   检查      │               │  Lint 问题  │
└─────────────┘               └──────┬──────┘
    │ 通过                           │
    ▼                                │
┌─────────────┐     失败      ┌──────▼──────┐
│   测试      │──────────────▶│  自动修复   │
│   运行      │               │  测试失败   │
└─────────────┘               └──────┬──────┘
    │ 通过                           │
    ▼                                │
┌─────────────┐     发现问题   ┌──────▼──────┐
│   代码      │──────────────▶│  自动修复   │
│   审查      │               │  代码问题   │
└─────────────┘               └──────┬──────┘
    │ 通过                           │
    ▼                                │
┌─────────────┐                      │
│   完成      │◀─────────────────────┘
│   汇报      │
└─────────────┘
```

## 执行步骤

### 步骤 1：代码格式检查
```bash
# 自动检测项目类型并运行对应的 lint
# JavaScript/TypeScript
npm run lint || npx eslint . --fix

# Python
python -m flake8 || python -m black .

# Go
go fmt ./... && go vet ./...
```

**失败处理**：自动运行 `--fix` 修复，修复后重新检查

### 步骤 2：运行测试
```bash
# 自动检测并运行测试
npm test          # Node.js
pytest            # Python
go test ./...     # Go
cargo test        # Rust
```

**失败处理**：
1. 分析失败的测试用例
2. 定位问题代码
3. 自动修复
4. 重新运行测试（最多 3 次）

### 步骤 3：代码审查
```
检查项：
- [ ] 代码逻辑正确性
- [ ] 潜在的 null/undefined 错误
- [ ] 边界条件处理
- [ ] 安全漏洞（SQL注入、XSS等）
- [ ] 性能问题
- [ ] 代码重复
```

**发现问题**：自动修复后重新审查

### 步骤 4：完成汇报
```
流水线执行完成：
✅ Lint: 通过（自动修复 X 个问题）
✅ 测试: X/X 通过
✅ 审查: 无严重问题

可以提交代码。
```

## 快速触发

```
# 对当前修改运行流水线
"运行流水线"
"跑一下 CI"
"自动检查代码"

# 对指定文件运行
"对 src/api.ts 运行流水线"

# 完整流程
"写完代码后自动跑流水线"

# 恢复中断
"继续流水线"
"resume pipeline"
```

## 断点续传

### 进度记录
流水线执行中，更新 `.claude-pipeline.json`：

```json
{
  "started_at": "2024-01-01T10:00:00Z",
  "current_step": 2,
  "steps": ["lint", "test", "review"],
  "completed": ["lint"],
  "results": {
    "lint": {"status": "pass", "fixed": 3}
  }
}
```

### 中断恢复
重连后说 "继续流水线"：
- 读取进度，从中断步骤继续

## 配置选项

```yaml
# 可在提示中指定
跳过测试: false      # "运行流水线，跳过测试"
跳过审查: false      # "只跑 lint 和测试"
自动修复: true       # "只检查不修复"
最大重试: 3          # 默认重试 3 次
```

## 输出格式

### 执行中
```
🔄 [1/3] 运行 Lint 检查...
✅ [1/3] Lint 通过

🔄 [2/3] 运行测试...
⚠️  [2/3] 2 个测试失败，尝试修复...
🔧 [2/3] 修复 calculateTotal 函数边界条件
🔄 [2/3] 重新运行测试...
✅ [2/3] 测试全部通过

🔄 [3/3] 代码审查...
✅ [3/3] 审查通过
```

### 最终结果
```
════════════════════════════════════════
📋 流水线执行完成

状态: ✅ 全部通过

详情:
  • Lint:  ✅ 通过 (自动修复 3 处格式问题)
  • 测试:  ✅ 15/15 通过 (修复 1 个失败用例)
  • 审查:  ✅ 无问题

耗时: 约 45 秒
════════════════════════════════════════
```
