---
name: auto-fix-loop
description: 自动修复循环。持续运行测试/构建并自动修复错误直到通过。当用户要求"自动修复"、"修到通过为止"、"fix loop"时使用。
allowed-tools: Read, Write, Edit, Bash, Grep, Glob
related-skills: autonomous-dev, auto-code-pipeline, bug-finder, test-generator
---

# 自动修复循环

持续运行检查命令，自动分析并修复错误，直到全部通过。

## 工作原理

```
┌──────────────────────────────────────────────┐
│                                              │
│    ┌─────────┐    失败    ┌─────────┐       │
│    │  运行   │───────────▶│  分析   │       │
│    │  命令   │            │  错误   │       │
│    └─────────┘            └────┬────┘       │
│         ▲                      │            │
│         │                      ▼            │
│         │               ┌─────────┐         │
│         │               │  自动   │         │
│         └───────────────│  修复   │         │
│              修复后重试  └─────────┘         │
│                                              │
│    ┌─────────┐                              │
│    │  成功   │◀─── 通过 ───┘                │
│    │  退出   │                              │
│    └─────────┘                              │
│                                              │
└──────────────────────────────────────────────┘
```

## 支持的检查类型

### 测试修复
```bash
# 触发
"自动修复测试直到通过"
"fix tests until pass"

# 执行
npm test → 失败 → 分析 → 修复 → 重试 → ...
```

### 构建修复
```bash
# 触发
"自动修复构建错误"
"fix build errors"

# 执行
npm run build → 失败 → 分析 → 修复 → 重试 → ...
```

### TypeScript 类型错误
```bash
# 触发
"修复所有类型错误"
"fix all type errors"

# 执行
npx tsc --noEmit → 失败 → 分析 → 修复 → 重试 → ...
```

### Lint 错误
```bash
# 触发
"自动修复 lint"
"fix all lint errors"

# 执行
npm run lint → 失败 → eslint --fix → 重试 → ...
```

### 自定义命令
```bash
# 触发
"运行 'make check' 直到通过"
"fix loop: pytest -x"

# 执行
{用户命令} → 失败 → 分析 → 修复 → 重试 → ...
```

## 修复策略

### 错误分析
```
1. 解析命令输出
2. 提取错误信息：
   - 文件路径
   - 行号
   - 错误类型
   - 错误描述
3. 定位问题代码
4. 理解上下文
```

### 修复优先级
```
1. 语法错误 → 直接修复
2. 类型错误 → 添加类型/修改类型
3. 测试失败 → 修复代码逻辑或更新测试
4. Lint 错误 → 自动格式化
5. 运行时错误 → 分析堆栈，修复逻辑
```

### 安全限制
```
❌ 不会删除测试用例来"通过"测试
❌ 不会注释掉代码来避免错误
❌ 不会降低类型严格性（如添加 any）
✅ 只做合理的代码修复
```

## 执行参数

```yaml
最大循环次数: 10        # 防止无限循环
单次最大修复: 5         # 每轮最多修复 5 个错误
超时时间: 300秒         # 5 分钟超时
静默模式: false         # 是否显示详细过程
```

## 输出格式

### 执行过程
```
🔄 自动修复循环启动
   命令: npm test
   最大尝试: 10 次

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[尝试 1/10]
❌ 3 个测试失败

分析错误:
  1. src/utils.ts:42 - TypeError: Cannot read property 'x' of undefined
  2. src/api.ts:87 - 预期值不匹配
  3. src/api.ts:92 - 超时错误

修复中...
  ✓ 修复 src/utils.ts:42 - 添加空值检查
  ✓ 修复 src/api.ts:87 - 修正计算逻辑
  ✓ 修复 src/api.ts:92 - 增加超时时间

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[尝试 2/10]
✅ 所有测试通过！

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎉 自动修复完成

总结:
  • 尝试次数: 2
  • 修复问题: 3
  • 修改文件: 2
  • 总耗时: 32 秒
```

### 失败退出
```
❌ 自动修复循环终止

原因: 达到最大尝试次数 (10)
剩余错误: 2

未能修复的问题:
  1. src/complex.ts:156 - 逻辑错误，需要人工分析
  2. src/external.ts:42 - 外部依赖问题

建议:
  - 检查 src/complex.ts 的业务逻辑
  - 确认外部服务是否可用
```

## 触发方式

```bash
# 测试修复
"自动修复测试"
"fix tests"
"测试跑到过为止"

# 构建修复
"修复构建错误"
"fix build"

# 类型修复
"修复类型错误"
"fix types"

# 自定义
"运行 {命令} 直到通过"
"fix loop: {命令}"
```
